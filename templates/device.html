{% extends "base.html" %}
{% block content %}

<div class ="section" id="section_1">
    <div class ="banner" id ="banner_1"></div>
    <div id="section_text">
    <h1>BISMark Device           <a href ="/editDevicePage/{{detail.hashkey}}"> Edit </a></h1>
    <script src="/static/jquery-latest.js"></script>
    <script src="/static/highcharts.js"></script>
    <script src="/static/js/modules/exporting.js"></script>

    <table>
        <!--
        <tr><td>MAC Address</td><td>{{ detail.macid }}</td></tr>
        <tr><td>Type</td><td>{{ detail.type }}</td></tr>
        <tr><td>Operating System</td><td>{{ detail.os }}</td></tr> -->
        <tr><td><b>Name</b></td><td><b>{{ detail.name }}</b></td></tr>
        <tr><td>ISP</td><td>{{ detail.isp }}</td></tr>
        <tr><td>Location</td><td><div id="location{{ deviceid }}"></div><script type="text/javascript">

		$.ajax({
                type: "GET",
                url: escape("/getLocation/{{ deviceid }}/"),
                success: OnSuccess
            });
		
		function OnSuccess(data)
		{
		document.getElementById('location{{ deviceid }}').innerHTML = data;
		}

		</script></td>
        </tr>     
        <tr><td>Service Plan</td><td>{{ detail.serviceplan }}</td></tr>
        <tr><td>Download Rate</td><td>{{ detail.downloadrate}} kbps</td></tr>
        <tr><td>Upload Rate</td><td>{{ detail.uploadrate}} kbps</td></tr>
    
 
  
        
	

<tr><td>First Measurement</td><td>{{ firstUpdate }}</td></tr>
<tr><td>Last Measurement</td><td>{{ lastUpdate }}</td></tr>

 
<tr><td>Raw Data</td></td><td><a href="http://projectbismark.net/data/{{ deviceid }}">Download XML</a></td></tr>

<tr><td>URL for this device page</td><td><input id="url" type="text" style="width:320px;" value="http://networkdashboard.org/displayDevice/{{ detail.hashkey }}" ></td></tr>
<tr><td><a href ="/feedback.html/?hashkey={{detail.hashkey}}" onClick ="return feedback(this, 'feedback')"><b>Feedback</b></a></td></tr>
    
</table>
</div>
</div>
<div class="section" id="section_2">
    <div class ="banner" id ="banner_1"></div>
    <div id ="section_text">

<script type="text/javascript" src="/static/dygraph-combined.js"></script>


<body class=" claro " onload="CloseProgressBar()">


<table border="0"> 

<tr>
<td>
<input type="radio" name="g1" id="g1rb3" checked>
<label for="g1rb3">Upload and Download Throughput (kbps)</label><br/><br/>
<input type="radio" name="g1" id="g1rb2">
<label for="g1rb2">Last-Mile Latency (ms)</label><br/><br/>
<input type="radio" name="g1" id="g1rb1">
<label for="g1rb1">Round Trip Time (ms)</label><br/><br/>
<input type="radio" name="g1" id="g1rb4">
<label for="g1rb1">Passive Measurements</label><br/><br/>
<input type="radio" name="g1" id="g1rb5">
<label for="g1rb5">Passive Measurement By Port<p style="font-size: 12;">Note: Passive Data not collected without explicit permission by user</p></label>
<div class="menu" id="drop_menu_1">
    Compare to other devices based on:<br/>
    <select id="select_menu_1">
        <option value = "none" selected>Don't Compare</option>
        <option value ="location">Location({{num_location}})</option>
        <option value ="provider">Provider({{num_provider}})</option>
    </select>
</div>
<button type="submit" name="submit" onClick=" render()">Display</button>
</td>
</tr>
</table>

</div>
</div>


        

<br />
<div class="progresscontainer">
    <div class="progressbar" id="progress" indeterminate="true" title="loading" ></div>
</div>
<br /><br /><br />
<div class ="graphdisplay" id = "display_tag" >
    <div class ="outergraphdiv" id="graph_div_outer_1">
        <div class ="graphdiv" id="graph_div_1"></div>
    </div>
    <div class ="outergraphdiv" id="graph_div_outer_2">
        <div class ="graphdiv" id="graph_div_2"></div>
    </div>
    <div class ="outergraphdiv" id="graph_div_outer_3">
        <div class ="graphdiv" id="graph_div_3"></div>
    </div>
    <div class ="outergraphdiv" id="graph_div_outer_4">
        <div class ="graphdiv" id="graph_div_4"></div>
    </div>
    <div class ="outergraphdiv" id="graph_div_outer_5">
        <div class ="graphdiv" id="graph_div_5"></div>
    </div>
    <div class ="outergraphdiv" id="graph_div_outer_6">
        <div class ="graphdiv" id="graph_div_6"></div>
    </div>
        
</div>
    
<!--    <div class ="radiodiv"
    <input type="radio" name = "mode" id="lin" onClick="setDisplayMode(false)" checked>
    <label for="lin">Linear</label>

    <input type="radio" name = "mode" id="log" onClick ="setDisplayMode(true)">
    <label for="log">Log</label><br /><br />
    </div>-->
<script type="text/javascript">

	var content="[not loaded]";
	var limit = 1000000;
	
	var paramselect = "AGGL3BITRATE";
        var logdisplay = false;
        var filter = "none";
        
        var formatter = function(){
            return ''+ Highcharts.dateFormat('%e. %b %Y, %l %p', this.x) +': <br/> <br/><b>'+ this.points[0].y +'</b> m/s';
        };
        var legend = {
            enabled: true,
            align: 'right',
            backgroundColor: '#FCFFC5',
            borderColor: 'black',
            borderWidth: 2,
            layout: 'vertical',
            verticalAlign: 'top',
            y: 100,
            shadow: true
        };
        
        
        
            
        var plotoptions = {};

       	render();
	
	function createStyle()
	{
            var sel = document.getElementById("select_menu_1");
            filter = sel.options[sel.selectedIndex].value;         
	}

     
        function feedback(link,windowname){
            if (! window.focus){
                return true;
            }
            var href;
            if (typeof(mylink) == 'string'){
               href=link;
            }
            else{
               href=link.href;
            }
            window.open(href, windowname, 'width=500,height=200,scrollbars=yes,location=0,status=0');
            return false;
        }
        
        function createParameters(i){
            var url = "/line_bitrate/";
            var graphno = 1;
            var divid = "graph_div_1";
            var titlename ="Download Throughput";
            var formatter = function(){};
            var legend = {
                enabled: true,
                align: 'right',
                backgroundColor: '#FCFFC5',
                borderColor: 'black',
                borderWidth: 2,
                layout: 'vertical',
                verticalAlign: 'top',
                y: 100,
                shadow: true
            };
            var rangeselector={
                buttons: [{
                        type: 'day',
                        count: 1,
                        text: '1d'
                }, {
                        type: 'week',
                        count: 1,
                        text: '1w'
                }, {
                        type: 'month',
                        count: 1,
                        text: '1m'
                }, {
                        type: 'month',
                        count: 3,
                        text: '3m'
                }, {
                        type: 'month',
                        count: 6,
                        text: '6m'
                }, {
                        type: 'ytd',
                        text: 'YTD'
                }, {
                        type: 'year',
                        count: 1,
                        text: '1y'
                }, {
                        type: 'all',
                        text: 'All'
                }],
                selected: 1
            };
            var plotoptions = {};
            var units = "KBps";
            
   
            switch (i){
                case 0:
                    formatter = function(){
                            return ''+ '<p style="color:' + this.points[0].series.color +  ';">' + this.points[0].series.name+ '</p><br />'+ Highcharts.dateFormat('%A,%e. %b %Y, %l %p', this.x) +' <br/><b>'+ parseInt(this.points[0].y)+'</b> KBps';
                        };
                    break;
                case 1:
                    divid = "graph_div_2";
                    graphno = 2;
                    titlename = "Upload Throughput";
                    break;
                case 2:
                    units = "msec";
                    titlename = "Round-Trip Time";
                    divid = "graph_div_3";
                    url = "/line_rtt/";
                    formatter = function(){
                        return ''+ '<p style="color:' + this.points[0].series.color +  ';">' + this.points[0].series.name+ '</p><br />' + Highcharts.dateFormat('%A, %e. %b %Y, %l:%M %p', this.x) +' <br/><b>'+ parseInt(this.points[0].y) +'</b> msec';
                    }
                    break;
                case 3:
                    units = "msec";
                    titlename = "Last Mile Latency";
                    divid = "graph_div_4";
                    url = "/line_lmrtt/";
                    formatter = function(){
                        return ''+ '<p style="color:' + this.points[0].series.color +  ';">' + this.points[0].series.name+ '</p><br />'+ Highcharts.dateFormat('%A, %e. %b %Y, %l:%M %p', this.x) +' <br/><b>'+ parseInt(this.points[0].y) +'</b> msec';
                    }
                    break;
                    
                case 4:
                    titlename = "Passive Data";
                    divid = "graph_div_5";
                    units = "MB";
                    url = "/line_passive/";
                    formatter = function(){
                        return ''+ '<p style="color:' + this.points[0].series.color +  ';">' + this.points[0].series.name+ '</p><br />'+ Highcharts.dateFormat('%A,%e. %b %Y, %l %p', this.x) +' <br/><b>'+ parseInt(this.points[0].y/1000/1000) +'</b> MB';
                    };
                    plotoptions ={
                        series:{
                           dataGrouping:{
                               groupPixelWidth: 50,
                               units: [[
                                        'hour',
                                        [1]
                                ], [
                                        'day',
                                        [1]
                                ], [
                                        'week',
                                        [1]
                                ], [
                                        'month',
                                        [1, 3, 6]
                                ]]
                           } 
                        }
                    };
                    break;
                case 5:
                    paramselect = "PASSIVE_PORT";
                    titlename = "Passive Data By Port";
                    divid = "graph_div_6";
                    units = "MB";
                    url = "/line_passive_port/";
                    formatter = function(){
                        return ''+ '<p style="color:' + this.points[0].series.color +  ';">' + this.points[0].series.name+ '</p><br />'+ Highcharts.dateFormat('%A,%e. %b %Y, %l %p', this.x) +' <br/><b>'+ parseInt(this.points[0].y/1000/1000) +'</b> MB';
                    };
                    plotoptions ={
                        column: {
                          borderWidth: 0,
                          stacking: "normal"
                        },
                        series:{
                           dataGrouping:{
                               groupPixelWidth: 50,
                               units: [[
                                        'hour',
                                        [1]
                                ], [
                                        'day',
                                        [1]
                                ], [
                                        'week',
                                        [1]
                                ], [
                                        'month',
                                        [1, 3, 6]
                                ]]
                           } 
                        }

                    };
                    break;
                }
                
                var ret = {
                    legend: legend,
                    divid: divid,
                    titlename: titlename,
                    formatter: formatter,
                    rangeselector: rangeselector,
                    plotoptions: plotoptions,
                    units: units,
                    url: url,
                    graphno: graphno
                }
                
                return ret;
        }
        
        
        function OnSuccess(graphParams){
            return function(data){
                if(data.length>200){
                window.chart = new Highcharts.StockChart({
                chart: {
                    renderTo: graphParams.divid,
                    backgroundColor: "rgb(249,249,255)"
                },
                legend: graphParams.legend,

                rangeSelector: graphParams.rangeselector,

                title: {
                    text: graphParams.titlename
                },

                plotOptions: graphParams.plotoptions,

                xAxis: {
                    maxZoom: 1 * 24 * 3600000 // fourteen days
                },
                yAxis: {
                    min: 0,
                    maxZoom: 10000,
                    title: {
                        text: graphParams.units,
                        style:{
                            fontSize: 15
                        }
                    }

                },

                tooltip: {
                                           formatter: graphParams.formatter
                },

                series: eval(data)
            });
                }
                else{
                    var div = document.getElementById(graphParams.divid);
                    div.innerHTML="<div id = 'error'><b>Insufficient Data</b></div>";
                }
            }
            
            
        
        CloseProgressBar();
        }
        
  
            
		

   
        
        function setDisplayMode(log){
            g.updateOptions({logscale:log});
            logdisplay = log;
        }
        
        function convertURL(name){
            return encodeURIComponent(name);
        }
        

	
        function OnError(data)
        {
	  alert("data loading failed");
        }
        
        function deleteDivs(){
            
            var dtag = document.getElementById('display_tag');
            while(dtag.hasChildNodes()){
                dtag.removeChild(dtag.lastChild);
            }  
        }
        
        function createGraphDivs(){
            var dtag = document.getElementById('display_tag');
            var outer = document.createElement('div');
            outer.setAttribute('id','graph_div_outer');
            outer.setAttribute('class','outergraphdiv');
            var gd1 = document.createElement('div');
            gd1.setAttribute('id','graph_div_1');
            gd1.setAttribute('class','graphdiv');
            outer.appendChild(gd1);
            dtag.appendChild(outer);
            if (paramselect == 'AGGL3BITRATE'){
                outer = document.createElement('div');
                outer.setAttribute('id','graph_div_outer2');
                outer.setAttribute('class','outergraphdiv');
                var gd2 = document.createElement('div');
                gd2.setAttribute('id','graph_div_2');
                gd2.setAttribute('class','graphdiv');

                outer.appendChild(gd2);
                dtag.appendChild(outer);
            }
            
        }
        
        function addRadios(){
            setDisplayMode(false);
            if(document.getElementById('lin')){
                return;
            }
            if(paramselect=='AGGL3BITRATE'){
                return;
            }
            var dtag = document.getElementById('graph_div_outer');
            var rdiv = document.createElement('div');
            rdiv.setAttribute('class','radiodiv');
            rdiv.setAttribute('id', 'radio_div');
            var r1 = "<input type='radio' name = 'mode' id='lin' onClick='setDisplayMode(false)' checked>";
            var r2 = "<input type='radio' name = 'mode' id='log' onClick='setDisplayMode(true)'>";
            rdiv.innerHTML = "Linear: ";
            rdiv.innerHTML += r1;
            rdiv.innerHTML += "Log: ";
            rdiv.innerHTML += r2;
            dtag.appendChild(rdiv);
        }
        
        
        function addLabels(){
            
            if(document.getElementById('label_1')){
                return;
            }
            var outer1 = document.getElementById('graph_div_outer');
            var label1 = document.createElement('div');
            
            if(paramselect == "AGGL3BITRATE"){
                var outer2 = document.getElementById('graph_div_outer2');
                label1.innerHTML = '<b>Download Throughput (kbps)</b> <br />';
                var label2 = document.createElement('div');
                label2.innerHTML = '<br/><br/><b>Upload Throughput (kbps)</b><br />';
                label2.setAttribute('id','label_2');
                label2.setAttribute('align','center');
                outer2.appendChild(label2);
            }
            else if(paramselect == "RTT"){
                label1.innerHTML = '<b> Round Trip Time (msec)</b><br />';
            }
            else if(paramselect == "LMRTT"){
                label1.innerHTML = '<b> Last-Mile Latency (msec)</b><br />';
            }
            
            label1.setAttribute('id','label_1');
            label1.setAttribute('align','center');
            outer1.appendChild(label1);
            
        }
       
        
        function createGraphs(){
            for (var i =0; i<6; i++){
                var params = createParameters(i);
                $.ajax({
                        type: "GET",
                        url: params.url,
                        data: {'graphno' : params.graphno, 'deviceid': "{{deviceid}}", 'filter_by': filter},
                        success: OnSuccess(params)
                    });   
            }
        }

	function render()
	{

        //createStyle();
        //deleteDivs();
        //createGraphDivs();
        createGraphs();
        
        }

    function CloseProgressBar() {
                var progressbar_container = document.getElementById("progress");
                progressbar_container.style.display="none";
                //document.getElementById("graph_div").display = "block";

    }

    function OpenProgressBar() {
            var progressbar_container = document.getElementById("progress");
            progressbar_container.style.display="block";


    }

</script>
</body>


{% endblock %}
